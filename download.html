<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ログデータCSVダウンロード</title>
</head>
<body>
  <h1>ログデータCSVダウンロード</h1>

  <form id="downloadForm">
    <label>開始日時：<input type="datetime-local" id="startDate" required></label><br>
    <label>終了日時：<input type="datetime-local" id="endDate" required></label><br>
    <button type="submit">ダウンロード</button>
  </form>

  <script type="module">
    import { db, auth, collection, query, where, getDocs } from "./firebase.js";

    // JST形式に整形
    function formatToJST(date) {
      const jst = new Date(date.getTime() + (9 * 60 * 60 * 1000)); // UTC→JST
      const yyyy = jst.getFullYear();
      const mm = String(jst.getMonth() + 1).padStart(2, '0');
      const dd = String(jst.getDate()).padStart(2, '0');
      const hh = String(jst.getHours()).padStart(2, '0');
      const mi = String(jst.getMinutes()).padStart(2, '0');
      const ss = String(jst.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }

    document.getElementById('downloadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);

      if (start >= end) {
        alert("開始日時は終了日時より前にしてください");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        alert("ログインが必要です");
        return;
      }

      const userId = user.uid;
      const barcodeDataRef = collection(db, `users/${userId}/barcodeData`);
      const q = query(
        barcodeDataRef,
        where("time", ">=", start),
        where("time", "<=", end)
      );

      try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          alert("該当データがありません");
          return;
        }

        const rows = [["code", "serialNumber", "user", "cameraId", "timestamp"]];
        snapshot.forEach(doc => {
          const d = doc.data();
          rows.push([
            d.code,
            d.serialNumber,
            d.user,
            d.cameraId,
            formatToJST(d.time.toDate())
          ]);
        });

        const csv = rows.map(row => row.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const startLabel = formatToJST(start).replace(/[: ]/g, "_");
        const endLabel = formatToJST(end).replace(/[: ]/g, "_");
        const a = document.createElement("a");
        a.href = url;
        a.download = `log_${startLabel}_to_${endLabel}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("データ取得エラー", err);
        alert("ダウンロードに失敗しました");
      }
    });
  </script>
</body>
</html>
