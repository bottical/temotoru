<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ログデータCSVダウンロード</title>
</head>
<body>
  <h1>ログデータCSVダウンロード</h1>

  <form id="downloadForm">
    <label>開始日時：<input type="datetime-local" id="startDate" required></label><br>
    <label>終了日時：<input type="datetime-local" id="endDate" required></label><br>
    <button type="submit">ダウンロード</button>
  </form>

  <script type="module">
    import { db, auth, collection, query, where, getDocs } from "./firebase.js";
    import { formatTimestamp } from "./ui.js"; // 検索画面と共通フォーマットを使用

    document.getElementById('downloadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);

      if (start >= end) {
        alert("開始日時は終了日時より前にしてください");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        alert("ログインが必要です");
        return;
      }

      const userId = user.uid;
      const barcodeDataRef = collection(db, `users/${userId}/barcodeData`);
      const q = query(
        barcodeDataRef,
        where("time", ">=", start),
        where("time", "<=", end)
      );

      try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          alert("該当データがありません");
          return;
        }

        const rows = [["code", "serialNumber", "user", "cameraId", "timestamp"]];
        snapshot.forEach(doc => {
          const d = doc.data();
          rows.push([
            d.code,
            d.serialNumber,
            d.user,
            d.cameraId,
            formatTimestamp(d.time.toDate()) // ← 検索画面と同一形式
          ]);
        });

        const csv = rows.map(row => row.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        // ファイル名にも JST 表記を適用
        const formatForFilename = date => formatTimestamp(date).replace(/[年月日時分秒]/g, s => {
          return s === '年' || s === '月' || s === '日' ? '-' : s === '時' || s === '分' || s === '秒' ? '' : s;
        }).replace(/--/g, '-').replace(/-$/, '');

        const a = document.createElement("a");
        a.href = url;
        a.download = `log_${formatForFilename(start)}_to_${formatForFilename(end)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("データ取得エラー", err);
        alert("ダウンロードに失敗しました");
      }
    });
  </script>
</body>
</html>
