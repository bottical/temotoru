<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ログデータCSVダウンロード</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #downloadButton:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>ログデータCSVダウンロード</h1>

  <form id="downloadForm">
    <label>開始日時：<input type="datetime-local" id="startDate" required></label><br>
    <label>終了日時：<input type="datetime-local" id="endDate" required></label><br>
    <button type="submit" id="downloadButton">ダウンロード</button>
  </form>

  <script type="module">
    import { db, auth, collection, query, where, getDocs } from "./firebase.js";
    import { formatTimestamp } from "./ui.js";

    function formatForFilename(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const mi = String(date.getMinutes()).padStart(2, '0');
      const ss = String(date.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}_${hh}${mi}${ss}`;
    }

    document.getElementById('downloadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const button = document.getElementById("downloadButton");
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = "ダウンロード中...";

      const startInput = document.getElementById('startDate').value;
      const endInput = document.getElementById('endDate').value;
      const start = new Date(startInput);
      const end = new Date(endInput);

      if (!startInput || !endInput || start >= end) {
        alert("開始日時は終了日時より前にしてください");
        button.disabled = false;
        button.textContent = originalText;
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        alert("ログインが必要です");
        button.disabled = false;
        button.textContent = originalText;
        return;
      }

      const userId = user.uid;
      const barcodeDataRef = collection(db, `users/${userId}/barcodeData`);
      const q = query(barcodeDataRef, where("time", ">=", start), where("time", "<=", end));

      try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          alert("該当データがありません");
          return;
        }

        const rows = [["code", "serialNumber", "user", "cameraId", "timestamp"]];
        snapshot.forEach(doc => {
          const d = doc.data();
          const formatted = formatTimestamp(d.time.toDate());
          rows.push([
            d.code,
            d.serialNumber,
            d.user,
            d.cameraId,
            formatted
          ]);
        });

        const csv = rows.map(row => row.join(",")).join("\n");
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // 文字化け防止
        const blob = new Blob([bom, csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `log_${formatForFilename(start)}_to_${formatForFilename(end)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("CSVダウンロードエラー", err);
        alert("ダウンロードに失敗しました");
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  </script>
</body>
</html>
