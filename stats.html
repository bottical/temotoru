<!doctype html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å½“æ—¥ä½œæ¥­ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆï¼‰</title>
  <style>
    :root{
      /* Light theme (default) */
      --bg:#f3f4f6;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --accent:#3b82f6;
      --accent-soft:rgba(59,130,246,0.08);
      --border:#e5e7eb;
      --pill-bg:#f9fafb;
      --input-bg:#f9fafb;
      --badge-bg:#e5e7eb;
      --badge-ink:#374151;
      --bar-bg:#e5e7eb;
      --bar-label:#111827;
      --table-strip:#f9fafb;
    }
    :root[data-theme="dark"]{
      /* Dark theme */
      --bg:#020617;
      --card:#020617;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --accent:#60a5fa;
      --accent-soft:rgba(56,189,248,0.16);
      --border:#1f2937;
      --pill-bg:#020617;
      --input-bg:#020617;
      --badge-bg:#0b1325;
      --badge-ink:#e5e7eb;
      --bar-bg:#020617;
      --bar-label:#e5e7eb;
      --table-strip:#020617;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    .wrap{
      max-width:960px;
      margin:32px auto;
      padding:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    h1{
      font-size:22px;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--badge-bg);
      color:var(--badge-ink);
    }
    .icon-btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--pill-bg);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .icon-btn:hover{opacity:.9}

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width:640px){
      .row{grid-template-columns:1fr}
      .topbar{flex-direction:column;align-items:flex-start}
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    input,select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--input-bg);
      color:var(--ink);
      font-size:14px;
    }
    button{
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--pill-bg);
      color:var(--ink);
      cursor:pointer;
      font-size:14px;
    }
    button:hover{background:rgba(148,163,184,0.12)}

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    /* ===== å½“æ—¥é€²æ—ã‚¨ãƒªã‚¢ ===== */
    .stat{
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(0,3fr);
      gap:16px;
      align-items:stretch;
      margin:16px 0 8px;
    }
    @media (max-width:640px){
      .stat{
        grid-template-columns:1fr;
      }
    }
    .stat-main{
      background:var(--accent-soft);
      border-radius:16px;
      padding:14px 16px 12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:120px;
    }
    .stat-main-label{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .stat-progress-ring{
      margin:4px 0 6px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .progress-value{
      font-size:44px;
      font-weight:800;
      letter-spacing:.06em;
    }
    .ok{color:#22c55e}
    .warn{color:#f97316}
    .stat-main-meta{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      gap:8px;
      flex-wrap:wrap;
    }

    .stat-side{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-start;
      justify-content:center;
    }
    .pill{
      background:var(--pill-bg);
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
    .grid{
      margin-top:16px;
      border-collapse:collapse;
      width:100%;
      border-radius:12px;
      overflow:hidden;
      font-size:13px;
    }
    .grid th,
    .grid td{
      border-bottom:1px dashed var(--border);
      padding:8px 8px;
      text-align:left;
    }
    .grid th{
      color:var(--muted);
      font-weight:600;
      font-size:12px;
      background:rgba(148,163,184,0.04);
    }
    .grid tbody tr:nth-child(even){
      background:var(--table-strip);
    }
    .grid td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }

    .empty{
      color:var(--muted);
      padding:16px 0;
      text-align:center;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼…ãƒãƒ¼ */
    .bar-wrap{
      position:relative;
      height:18px;
      border-radius:999px;
      background:var(--bar-bg);
      overflow:hidden;
    }
    .bar-fill{
      position:absolute;
      inset:0;
      width:0;
      background:linear-gradient(90deg,var(--accent),#22c55e);
      transition:width .35s ease;
    }
    .bar-label{
      position:relative;
      font-size:11px;
      text-align:center;
      line-height:18px;
      color:var(--bar-label);
      font-variant-numeric:tabular-nums;
    }

    .footer{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
    .right{
      display:flex;
      gap:8px;
      align-items:end;
      justify-content:flex-end;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>
          å½“æ—¥ä½œæ¥­ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆï¼‰
          <span id="modeBadge" class="badge">â€”</span>
        </h1>
        <button id="themeToggle" class="icon-btn" type="button">
          <span id="themeIcon">ğŸŒ™</span><span>ãƒ†ãƒ¼ãƒåˆ‡æ›¿</span>
        </button>
      </div>

      <div class="row">
        <div>
          <label for="theDate">å¯¾è±¡æ—¥</label>
          <input id="theDate" type="date" />
          <div class="hint">â€» ä»Šæ—¥ã‚’é¸ã¶ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å·®åˆ†è³¼èª­ã€éå»æ—¥ãªã‚‰1å›ã ã‘å–å¾—ã—ã¾ã™</div>
        </div>
        <div>
          <label for="expected">å½“æ—¥ã®äºˆå®šä»¶æ•°ï¼ˆæ‰‹å…¥åŠ›ï¼‰</label>
          <input id="expected" type="number" min="0" step="1" placeholder="ä¾‹ï¼‰1200" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="intervalSec">æ›´æ–°é–“éš”ï¼ˆç§’ï¼‰</label>
          <select id="intervalSec" disabled>
            <option value="0" selected>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­ï¼æ‰‹å‹•</option>
          </select>
          <div class="hint">â€» ã“ã®æ”¹ä¿®ã§ã¯ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ä½¿ã„ã¾ã›ã‚“ï¼ˆé€šä¿¡é‡ã‚’æŠ‘åˆ¶ï¼‰</div>
        </div>
        <div class="right">
          <button id="refreshBtn" title="ä»Šã™ãå†é›†è¨ˆ">âŸ³ å†é›†è¨ˆ</button>
        </div>
      </div>

      <!-- é€²æ—ãƒã‚¤ãƒ©ã‚¤ãƒˆ -->
      <div class="stat">
        <div class="stat-main">
          <div class="stat-main-label">å½“æ—¥ã®é€²æ—ç‡</div>
          <div class="stat-progress-ring">
            <span id="progress" class="progress-value warn">0%</span>
          </div>
          <div class="stat-main-meta">
            <span>äºˆå®šï¼š<span id="expectedLabel">â€”</span> ä»¶</span>
            <span>å®Ÿç¸¾ï¼š<span id="totalInline">0</span> ä»¶</span>
          </div>
        </div>
        <div class="stat-side">
          <span class="pill">æœ€çµ‚æ›´æ–°: <span id="lastUpdated">â€”</span></span>
          <span class="pill">åˆè¨ˆä½œæ¥­ä»¶æ•°: <span id="total">0</span></span>
        </div>
      </div>

      <table class="grid" id="table">
        <thead>
          <tr>
            <th style="width:40%">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
            <th style="width:20%;text-align:right">ä»¶æ•°</th>
            <th>æ¯”ç‡</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="empty">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
        </tbody>
      </table>

      <div class="footer" id="footnote">
        ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼é…ä¸‹ã® <code>users/{uid}/barcodeData</code> ã‚’å¯¾è±¡ã«
        <code>time</code>ï¼ˆé¸æŠæ—¥ã® 00:00ã€œ23:59:59ï¼‰ã§çµã‚Šè¾¼ã‚“ã§é›†è¨ˆã—ã¾ã™ã€‚<br/>
        ä»Šæ—¥ã‚’é¸æŠæ™‚ã¯ <code>onSnapshot</code> ã«ã‚ˆã‚Šå·®åˆ†ã®ã¿å–ã‚Šè¾¼ã¿ã€éå»æ—¥ã¯ <code>getDocs</code> ã‚’1å›ã ã‘å®Ÿè¡Œã—ã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- æ—¢å­˜ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ©ç”¨ -->
  <script type="module">
    import {
      db, auth, onAuthStateChangedListener,
      collection, query, where, getDocs, orderBy, onSnapshot
    } from "./firebase.js";

    const $ = (id)=>document.getElementById(id);
    const tbody = $("tbody");
    const totalEl = $("total");
    const totalInlineEl = $("totalInline");
    const expectedLabelEl = $("expectedLabel");
    const progressEl = $("progress");
    const lastUpdatedEl = $("lastUpdated");
    const theDateEl = $("theDate");
    const expectedEl = $("expected");
    const refreshBtn = $("refreshBtn");
    const modeBadge = $("modeBadge");

    const themeToggle = $("themeToggle");
    const themeIcon   = $("themeIcon");
    const THEME_KEY   = "statsTheme";

    // ===== ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ =====
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      if (themeIcon){
        themeIcon.textContent = theme === "dark" ? "ãƒ€ãƒ¼ã‚¯" : "é€šå¸¸";
      }
    }
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "light" || saved === "dark"){
        applyTheme(saved);
      }else{
        const prefersDark = window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark" : "light");
      }
    })();
    if (themeToggle){
      themeToggle.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
        const next = current === "dark" ? "light" : "dark";
        applyTheme(next);
        localStorage.setItem(THEME_KEY, next);
      });
    }

    // æ—¢å®šå€¤: ä»Šæ—¥
    const jstTodayISO = (() => {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    })();
    theDateEl.value = jstTodayISO;

    let currentUid = null;
    let unsubscribe = null;   // onSnapshotè§£é™¤ç”¨
    let counter = new Map();  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä»¶æ•°
    let total = 0;            // åˆè¨ˆä»¶æ•°

    onAuthStateChangedListener(async (user) => {
      if (!user) {
        tbody.innerHTML = `<tr><td colspan="3" class="empty">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</td></tr>`;
        setModeBadge("â€”");
        cleanupSubscription();
        return;
      }
      currentUid = user.uid;
      await startAggregation(); // åˆå›ã‚¹ã‚¿ãƒ¼ãƒˆ
    });

    window.addEventListener("beforeunload", cleanupSubscription);

    function cleanupSubscription(){
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }
    }

    function setModeBadge(text){
      modeBadge.textContent = text;
    }

    function startOfDayJST(dateStr){
      const [y,m,d] = dateStr.split("-").map(Number);
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    function endOfDayJST(dateStr){
      const [y,m,d] = dateStr.split("-").map(Number);
      return new Date(y, m-1, d, 23, 59, 59, 999);
    }
    function fmtTime(dt){
      const y=dt.getFullYear(), mo=String(dt.getMonth()+1).padStart(2,"0"), da=String(dt.getDate()).padStart(2,"0");
      const hh=String(dt.getHours()).padStart(2,"0"), mi=String(dt.getMinutes()).padStart(2,"0"), ss=String(dt.getSeconds()).padStart(2,"0");
      return `${y}-${mo}-${da} ${hh}:${mi}:${ss}`;
    }
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
    }

    // ====== é›†è¨ˆã‚¨ãƒ³ã‚¸ãƒ³ ======
    async function startAggregation(){
      if (!currentUid) return;

      // æ—¢å­˜è³¼èª­ã‚’å¤–ã—ã€çŠ¶æ…‹ã‚’åˆæœŸåŒ–
      cleanupSubscription();
      counter = new Map();
      total = 0;
      renderTable(counter, total);
      updateProgress(total);
      lastUpdatedEl.textContent = "â€”";

      const day = theDateEl.value;
      const start = startOfDayJST(day);
      const end = endOfDayJST(day);

      const ref = collection(db, `users/${currentUid}/barcodeData`);
      const isToday = (theDateEl.value === jstTodayISO);

      if (isToday) {
        // ä»Šæ—¥ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å·®åˆ†è³¼èª­ï¼ˆåˆå›ã«å½“æ—¥å…¨ä»¶â†’ä»¥å¾Œã¯å·®åˆ†ã®ã¿ï¼‰
        setModeBadge("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆå·®åˆ†è³¼èª­ï¼‰");
        const q = query(
          ref,
          where("time", ">=", start),
          where("time", "<=", end),
          orderBy("time", "asc")
        );
        unsubscribe = onSnapshot(q, (snap) => {
          if (snap.metadata.fromCache && !snap.metadata.hasPendingWrites) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®åˆæœŸèª­ã¿è¾¼ã¿ã§ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚OKï¼ˆä»»æ„ï¼‰
          }
          let changed = false;
          snap.docChanges().forEach(change => {
            const data = change.doc.data();
            const key = data.user ?? "(ä¸æ˜)";
            if (change.type === "added") {
              counter.set(key, (counter.get(key)||0) + 1);
              total += 1;
              changed = true;
            } else if (change.type === "modified") {
              // è¿½åŠ ã‚ªãƒ³ãƒªãƒ¼æƒ³å®šãªã‚‰ä¸è¦ã€‚ã‚‚ã—ã€Œuserã€å¤‰æ›´ãŒã‚ã‚Šå¾—ã‚‹é‹ç”¨ãªã‚‰å†é›†è¨ˆãŒå¿…è¦ã€‚
            } else if (change.type === "removed") {
              // å‰Šé™¤é‹ç”¨ãŒã‚ã‚Šå¾—ã‚‹ãªã‚‰å†è¨ˆç®—ãŒå¿…è¦ï¼ˆã“ã“ã§ã¯çœç•¥ï¼‰
            }
          });
          if (changed){
            renderTable(counter, total);
            updateProgress(total);
          }
          lastUpdatedEl.textContent = fmtTime(new Date());
        }, (err) => {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="3" class="empty">è³¼èª­ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${err.message ?? err}</td></tr>`;
          setModeBadge("ã‚¨ãƒ©ãƒ¼");
        });

      } else {
        // éå»æ—¥ï¼š1å›ã ã‘å–å¾—
        setModeBadge("å˜å›å–å¾—ï¼ˆéå»æ—¥ï¼‰");
        const q = query(ref, where("time", ">=", start), where("time", "<=", end));
        try{
          const snap = await getDocs(q);
          snap.forEach(doc=>{
            const data = doc.data();
            const key = data.user ?? "(ä¸æ˜)";
            counter.set(key, (counter.get(key)||0) + 1);
            total += 1;
          });
          renderTable(counter, total);
          updateProgress(total);
          lastUpdatedEl.textContent = fmtTime(new Date());
        }catch(e){
          console.error(e);
          tbody.innerHTML = `<tr><td colspan="3" class="empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e.message ?? e}</td></tr>`;
          setModeBadge("ã‚¨ãƒ©ãƒ¼");
        }
      }
    }

    function renderTable(counterMap, total){
      if (counterMap.size === 0){
        tbody.innerHTML = `<tr><td colspan="3" class="empty">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
        totalEl.textContent = "0";
        if (totalInlineEl) totalInlineEl.textContent = "0";
        return;
      }
      const rows = [];
      const sorted = Array.from(counterMap.entries()).sort((a,b)=>{
        if (b[1] !== a[1]) return b[1]-a[1];
        return a[0].localeCompare(b[0]);
      });

      for (const [userId, count] of sorted){
        const ratio = total>0 ? Math.round((count/total)*100) : 0;
        rows.push(`
          <tr>
            <td>${escapeHTML(userId)}</td>
            <td class="num">${count}</td>
            <td>
              <div class="bar-wrap">
                <div class="bar-fill" style="width:${ratio}%;"></div>
                <div class="bar-label">${ratio}%</div>
              </div>
            </td>
          </tr>
        `);
      }
      tbody.innerHTML = rows.join("");
      totalEl.textContent = String(total);
      if (totalInlineEl) totalInlineEl.textContent = String(total);
    }

    function updateProgress(currentTotal){
      const expected = parseInt(expectedEl.value,10);
      let pct = 0;
      if (!isNaN(expected) && expected > 0){
        pct = Math.min(999, Math.round((currentTotal/expected)*100));
      }
      progressEl.textContent = pct + "%";
      progressEl.classList.remove("ok","warn");
      progressEl.classList.add(pct>=100 ? "ok" : "warn");

      if (expectedLabelEl){
        expectedLabelEl.textContent = (!isNaN(expected) && expected>0) ? expected : "â€”";
      }
      if (totalInlineEl){
        totalInlineEl.textContent = String(currentTotal);
      }
    }

    // ====== UIã‚¤ãƒ™ãƒ³ãƒˆ ======
    theDateEl.addEventListener("change", startAggregation);
    expectedEl.addEventListener("input", () => updateProgress(total));
    refreshBtn.addEventListener("click", startAggregation);
  </script>
</body>
</html>
