<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>当日作業カウンタ（ユーザー別集計）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .wrap{max-width:960px;margin:32px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0b1325;color:var(--ink)}
    button{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#111b35;color:var(--ink);cursor:pointer}
    button:hover{background:#162246}
    .grid{margin-top:16px;border-collapse:collapse;width:100%}
    .grid th,.grid td{border-bottom:1px dashed var(--border);padding:10px 8px;text-align:left}
    .grid th{color:var(--muted);font-weight:600;font-size:12px}
    .stat{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0}
    .pill{background:#0b1325;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:12px;color:var(--muted)}
    .big{font-size:28px;font-weight:700}
    .ok{color:#78e08f} .warn{color:#f8c291}
    .footer{margin-top:8px;font-size:12px;color:var(--muted)}
    .right{display:flex;gap:8px;align-items:end;justify-content:flex-end}
    .empty{color:var(--muted);padding:16px 0}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .badge{font-size:11px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#0b1325;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>当日作業カウンタ（ユーザー別集計） <span id="modeBadge" class="badge">—</span></h1>

      <div class="row">
        <div>
          <label for="theDate">対象日</label>
          <input id="theDate" type="date" />
          <div class="hint">※ 今日を選ぶとリアルタイム差分購読、過去日なら1回だけ取得します</div>
        </div>
        <div>
          <label for="expected">当日の予定件数（手入力）</label>
          <input id="expected" type="number" min="0" step="1" placeholder="例）1200" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="intervalSec">更新間隔（秒）</label>
          <select id="intervalSec" disabled>
            <option value="0" selected>リアルタイム購読／手動</option>
          </select>
          <div class="hint">※ この改修ではポーリングを使いません（通信量を抑制）</div>
        </div>
        <div class="right">
          <button id="refreshBtn" title="今すぐ再集計">⟳ 再集計</button>
        </div>
      </div>

      <div class="stat">
        <span class="pill">最終更新: <span id="lastUpdated">—</span></span>
        <span class="pill">合計作業件数: <span id="total" class="big">0</span></span>
        <span class="pill">進捗率: <span id="progress" class="big">0%</span></span>
      </div>

      <table class="grid" id="table">
        <thead>
          <tr><th style="width:40%">ユーザーID</th><th style="width:20%">件数</th><th>比率</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="empty">データを読み込み中…</td></tr>
        </tbody>
      </table>

      <div class="footer" id="footnote">
        ログインユーザー配下の <code>users/{uid}/barcodeData</code> を対象に
        <code>time</code>（選択日の 00:00〜23:59:59）で絞り込んで集計します。<br/>
        今日を選択時は <code>onSnapshot</code> により差分のみ取り込み、過去日は <code>getDocs</code> を1回だけ実行します。
      </div>
    </div>
  </div>

  <!-- 既存のモジュールを利用 -->
  <script type="module">
    import {
      db, auth, onAuthStateChangedListener,
      collection, query, where, getDocs, orderBy, onSnapshot
    } from "./firebase.js";

    const $ = (id)=>document.getElementById(id);
    const tbody = $("tbody");
    const totalEl = $("total");
    const progressEl = $("progress");
    const lastUpdatedEl = $("lastUpdated");
    const theDateEl = $("theDate");
    const expectedEl = $("expected");
    const refreshBtn = $("refreshBtn");
    const modeBadge = $("modeBadge");

    // 既定値: 今日
    const jstTodayISO = (() => {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    })();
    theDateEl.value = jstTodayISO;

    let currentUid = null;
    let unsubscribe = null;   // onSnapshot解除用
    let counter = new Map();  // ユーザー別件数
    let total = 0;            // 合計件数

    onAuthStateChangedListener(async (user) => {
      if (!user) {
        tbody.innerHTML = `<tr><td colspan="3" class="empty">ログインが必要です。</td></tr>`;
        setModeBadge("—");
        cleanupSubscription();
        return;
      }
      currentUid = user.uid;
      await startAggregation(); // 初回スタート
    });

    window.addEventListener("beforeunload", cleanupSubscription);

    function cleanupSubscription(){
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }
    }

    function setModeBadge(text){
      modeBadge.textContent = text;
    }

    function startOfDayJST(dateStr){
      const [y,m,d] = dateStr.split("-").map(Number);
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    function endOfDayJST(dateStr){
      const [y,m,d] = dateStr.split("-").map(Number);
      return new Date(y, m-1, d, 23, 59, 59, 999);
    }
    function fmtTime(dt){
      const y=dt.getFullYear(), mo=String(dt.getMonth()+1).padStart(2,"0"), da=String(dt.getDate()).padStart(2,"0");
      const hh=String(dt.getHours()).padStart(2,"0"), mi=String(dt.getMinutes()).padStart(2,"0"), ss=String(dt.getSeconds()).padStart(2,"0");
      return `${y}-${mo}-${da} ${hh}:${mi}:${ss}`;
    }
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
    }

    // ====== 集計エンジン ======
    async function startAggregation(){
      if (!currentUid) return;

      // 既存購読を外し、状態を初期化
      cleanupSubscription();
      counter = new Map();
      total = 0;
      renderTable(counter, total);
      updateProgress(total);
      lastUpdatedEl.textContent = "—";

      const day = theDateEl.value;
      const start = startOfDayJST(day);
      const end = endOfDayJST(day);

      const ref = collection(db, `users/${currentUid}/barcodeData`);
      const isToday = (theDateEl.value === jstTodayISO);

      if (isToday) {
        // 今日：リアルタイム差分購読（初回に当日全件→以後は差分のみ）
        setModeBadge("リアルタイム（差分購読）");
        const q = query(
          ref,
          where("time", ">=", start),
          where("time", "<=", end),
          orderBy("time", "asc")
        );
        unsubscribe = onSnapshot(q, (snap) => {
          if (snap.metadata.fromCache && !snap.metadata.hasPendingWrites) {
            // キャッシュからの初期読み込みであればスキップしてもOK（任意）
          }
          let changed = false;
          snap.docChanges().forEach(change => {
            const data = change.doc.data();
            const key = data.user ?? "(不明)";
            if (change.type === "added") {
              counter.set(key, (counter.get(key)||0) + 1);
              total += 1;
              changed = true;
            } else if (change.type === "modified") {
              // 追加オンリー想定なら不要。もし「user」変更があり得る運用なら再集計が必要。
            } else if (change.type === "removed") {
              // 削除運用があり得るなら再計算が必要（ここでは省略）
            }
          });
          if (changed){
            renderTable(counter, total);
            updateProgress(total);
          }
          lastUpdatedEl.textContent = fmtTime(new Date());
        }, (err) => {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="3" class="empty">購読に失敗しました：${err.message ?? err}</td></tr>`;
          setModeBadge("エラー");
        });

      } else {
        // 過去日：1回だけ取得
        setModeBadge("単回取得（過去日）");
        const q = query(ref, where("time", ">=", start), where("time", "<=", end));
        try{
          const snap = await getDocs(q);
          snap.forEach(doc=>{
            const data = doc.data();
            const key = data.user ?? "(不明)";
            counter.set(key, (counter.get(key)||0) + 1);
            total += 1;
          });
          renderTable(counter, total);
          updateProgress(total);
          lastUpdatedEl.textContent = fmtTime(new Date());
        }catch(e){
          console.error(e);
          tbody.innerHTML = `<tr><td colspan="3" class="empty">読み込みに失敗しました：${e.message ?? e}</td></tr>`;
          setModeBadge("エラー");
        }
      }
    }

    function renderTable(counterMap, total){
      if (counterMap.size === 0){
        tbody.innerHTML = `<tr><td colspan="3" class="empty">該当データがありません。</td></tr>`;
        totalEl.textContent = "0";
        return;
      }
      const rows = [];
      const sorted = Array.from(counterMap.entries()).sort((a,b)=>{
        if (b[1] !== a[1]) return b[1]-a[1];
        return a[0].localeCompare(b[0]);
      });

      for (const [userId, count] of sorted){
        const ratio = total>0 ? Math.round((count/total)*100) : 0;
        rows.push(`<tr><td>${escapeHTML(userId)}</td><td>${count}</td><td>${ratio}%</td></tr>`);
      }
      tbody.innerHTML = rows.join("");
      totalEl.textContent = String(total);
    }

    function updateProgress(total){
      const expected = parseInt(expectedEl.value,10);
      let pct = 0;
      if (!isNaN(expected) && expected > 0){
        pct = Math.min(999, Math.round((total/expected)*100));
      }
      progressEl.textContent = pct + "%";
      progressEl.className = "big " + (pct>=100 ? "ok" : "warn");
    }

    // ====== UIイベント ======
    theDateEl.addEventListener("change", startAggregation);
    expectedEl.addEventListener("input", () => updateProgress(total));
    refreshBtn.addEventListener("click", startAggregation);
  </script>
</body>
</html>
